<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ - Browzyan</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; style-src 'self'; img-src 'self' https://www.google.com;">
  <link rel="stylesheet" href="styles.css">
  <style>
    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      height: 100vh;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }

    .history-container {
      padding: 20px;
      flex: 1;
      display: flex;
      flex-direction: column;
      height: calc(100vh - 40px);
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
    }

    .history-title {
      font-size: 24px;
      font-weight: 500;
      color: var(--text-color);
    }

    .search-container {
      display: flex;
      margin-bottom: 20px;
      max-width: 600px;
    }

    .search-input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: var(--card-bg);
      color: var(--text-color);
      font-size: 14px;
    }

    .search-button {
      margin-left: 10px;
      padding: 0 15px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .search-button:hover {
      background-color: var(--primary-hover);
    }

    .history-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .history-subtitle {
      font-size: 14px;
      font-weight: 500;
    }

    .history-buttons {
      display: flex;
      gap: 10px;
    }

    .history-button {
      background-color: var(--card-bg);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 8px 12px;
      font-size: 13px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .history-button:hover {
      background-color: var(--tab-hover-bg);
    }

    .history-button.danger {
      color: #e53935;
      border-color: rgba(229, 57, 53, 0.3);
    }

    .history-button.danger:hover {
      background-color: rgba(229, 57, 53, 0.05);
    }

    .history-list {
      background-color: var(--card-bg);
      border-radius: 8px;
      flex: 1;
      overflow: auto;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .history-group {
      padding: 10px 20px;
      border-bottom: 1px solid var(--border-color);
    }

    .history-group:last-child {
      border-bottom: none;
    }

    .group-header {
      padding: 8px 0;
      font-size: 14px;
      font-weight: 500;
      color: var(--primary-color);
    }

    .history-item {
      display: flex;
      align-items: center;
      padding: 10px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .history-item:hover {
      background-color: var(--tab-hover-bg);
    }

    .favicon {
      width: 16px;
      height: 16px;
      margin-right: 12px;
      border-radius: 2px;
    }

    .history-content {
      flex: 1;
      min-width: 0;
    }

    .history-title {
      font-size: 14px;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .history-url {
      font-size: 12px;
      color: #777;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .history-time {
      font-size: 12px;
      color: #777;
      margin-left: 10px;
      white-space: nowrap;
    }

    .history-delete {
      visibility: hidden;
      opacity: 0;
      margin-left: 10px;
      background: none;
      border: none;
      color: #777;
      cursor: pointer;
      padding: 5px;
      font-size: 16px;
      transition: opacity 0.2s;
    }

    .history-item:hover .history-delete {
      visibility: visible;
      opacity: 1;
    }

    .history-delete:hover {
      color: #e53935;
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 50px 20px;
      text-align: center;
      color: #777;
      height: 100%;
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .empty-title {
      font-size: 18px;
      margin-bottom: 10px;
      color: var(--text-color);
    }

    .empty-message {
      max-width: 400px;
      font-size: 14px;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s linear infinite;
    }

    [data-theme="dark"] .spinner {
      border-color: rgba(255, 255, 255, 0.1);
      border-top-color: var(--primary-color);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }

    .modal-overlay.visible {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background-color: var(--card-bg);
      border-radius: 8px;
      width: 400px;
      max-width: 90%;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .modal-header {
      padding: 15px 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-size: 16px;
      font-weight: 500;
      color: var(--text-color);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #777;
    }

    .modal-body {
      padding: 20px;
      color: var(--text-color);
    }

    .modal-body p {
      margin-bottom: 15px;
    }

    .modal-footer {
      padding: 15px 20px;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .period-options {
      margin-top: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .period-option {
      display: flex;
      align-items: center;
    }

    .period-option input {
      margin-right: 10px;
    }

    .period-option label {
      color: var(--text-color);
    }

    .modal-button {
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .modal-button.cancel {
      background-color: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-color);
    }

    .modal-button.cancel:hover {
      background-color: var(--tab-hover-bg);
    }

    .modal-button.danger {
      background-color: #e53935;
      border: 1px solid #e53935;
      color: white;
    }

    .modal-button.danger:hover {
      background-color: #d32f2f;
    }
  </style>
</head>
<body>
  <div class="history-container">
    <header class="history-header">
      <h1 class="history-title">–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</h1>
    </header>

    <div class="search-container">
      <input type="text" id="searchInput" class="search-input" placeholder="–ü–æ–∏—Å–∫ –≤ –∏—Å—Ç–æ—Ä–∏–∏">
      <button id="searchButton" class="search-button">–ù–∞–π—Ç–∏</button>
    </div>

    <div class="history-actions">
      <span class="history-subtitle">–í–∞—à–∞ –∏—Å—Ç–æ—Ä–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</span>
      <div class="history-buttons">
        <button id="clearTodayButton" class="history-button">–û—á–∏—Å—Ç–∏—Ç—å –∑–∞ —Å–µ–≥–æ–¥–Ω—è</button>
        <button id="clearAllButton" class="history-button danger">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é</button>
      </div>
    </div>

    <div id="historyContainer" class="history-list">
      <div class="loading">
        <div class="spinner"></div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ -->
  <div id="confirmModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</h3>
        <button id="modalClose" class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–æ—Å–º–æ—Ç—Ä–∞?</p>
        <div class="period-options" id="periodOptions">
          <div class="period-option">
            <input type="radio" id="periodHour" name="period" value="hour">
            <label for="periodHour">–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å</label>
          </div>
          <div class="period-option">
            <input type="radio" id="periodDay" name="period" value="day" checked>
            <label for="periodDay">–ó–∞ —Å–µ–≥–æ–¥–Ω—è</label>
          </div>
          <div class="period-option">
            <input type="radio" id="periodWeek" name="period" value="week">
            <label for="periodWeek">–ó–∞ –Ω–µ–¥–µ–ª—é</label>
          </div>
          <div class="period-option">
            <input type="radio" id="periodMonth" name="period" value="month">
            <label for="periodMonth">–ó–∞ –º–µ—Å—è—Ü</label>
          </div>
          <div class="period-option">
            <input type="radio" id="periodAll" name="period" value="all">
            <label for="periodAll">–í—Å—é –∏—Å—Ç–æ—Ä–∏—é</label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="cancelClearButton" class="modal-button cancel">–û—Ç–º–µ–Ω–∞</button>
        <button id="confirmClearButton" class="modal-button danger">–û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <script>
    // DOM-—ç–ª–µ–º–µ–Ω—Ç—ã
    const historyContainer = document.getElementById('historyContainer');
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    const clearTodayButton = document.getElementById('clearTodayButton');
    const clearAllButton = document.getElementById('clearAllButton');
    const confirmModal = document.getElementById('confirmModal');
    const modalClose = document.getElementById('modalClose');
    const cancelClearButton = document.getElementById('cancelClearButton');
    const confirmClearButton = document.getElementById('confirmClearButton');
    const periodOptions = document.querySelectorAll('input[name="period"]');
    
    // –°–æ—Å—Ç–æ—è–Ω–∏–µ
    let historyData = [];
    let selectedPeriod = 'day';
    let isSearchMode = false;
    
    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–º—ã
    function applyTheme(isDark) {
      if (isDark) {
        document.documentElement.setAttribute('data-theme', 'dark');
      } else {
        document.documentElement.removeAttribute('data-theme');
      }
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    function init() {
      console.log('[–ò—Å—Ç–æ—Ä–∏—è] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã');
      
      // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–≤–µ—Ç–ª—É—é —Ç–µ–º—É
      applyTheme(false);
      
      try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ API –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É –±—Ä–∞—É–∑–µ—Ä–∞
        if (window.electronAPI && typeof window.electronAPI.getDarkMode === 'function') {
          window.electronAPI.getDarkMode().then(isDark => {
            console.log(`[–ò—Å—Ç–æ—Ä–∏—è] –¢–µ–º–∞ –±—Ä–∞—É–∑–µ—Ä–∞: ${isDark ? '—Ç—ë–º–Ω–∞—è' : '—Å–≤–µ—Ç–ª–∞—è'}`);
            applyTheme(isDark);
          }).catch(err => {
            console.warn('[–ò—Å—Ç–æ—Ä–∏—è] –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–º—É –±—Ä–∞—É–∑–µ—Ä–∞:', err);
          });
        }
      } catch (error) {
        console.warn('[–ò—Å—Ç–æ—Ä–∏—è] –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç–µ–º—ã:', error);
      }
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
      loadHistory();
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
      searchButton.addEventListener('click', searchHistory);
      searchInput.addEventListener('keyup', e => {
        if (e.key === 'Enter') searchHistory();
      });
      
      clearTodayButton.addEventListener('click', () => showConfirmModal('day'));
      clearAllButton.addEventListener('click', () => showConfirmModal('all'));
      
      modalClose.addEventListener('click', hideConfirmModal);
      cancelClearButton.addEventListener('click', hideConfirmModal);
      confirmClearButton.addEventListener('click', clearHistory);
      
      periodOptions.forEach(option => {
        option.addEventListener('change', function() {
          selectedPeriod = this.value;
        });
      });
      
      console.log('[–ò—Å—Ç–æ—Ä–∏—è] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
    async function loadHistory() {
      console.log('[–ò—Å—Ç–æ—Ä–∏—è] –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏');
      
      try {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        historyContainer.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º API
        if (!window.electronAPI || typeof window.electronAPI.getRecentHistory !== 'function') {
          throw new Error('API –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ');
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        historyData = await window.electronAPI.getRecentHistory();
        console.log(`[–ò—Å—Ç–æ—Ä–∏—è] –ü–æ–ª—É—á–µ–Ω–æ ${historyData ? historyData.length : 0} –∑–∞–ø–∏—Å–µ–π`);
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
        renderHistory(historyData);
      } catch (error) {
        console.error('[–ò—Å—Ç–æ—Ä–∏—è] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
        showMockData();
      }
    }
    
    // –ü–æ–∫–∞–∑ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ)
    function showMockData() {
      const mockData = [
        { url: 'https://github.com', title: 'GitHub: Where the world builds software', timestamp: Date.now() - 10 * 60 * 1000 },
        { url: 'https://electronjs.org', title: 'Electron | Build cross-platform desktop apps with JavaScript, HTML, and CSS', timestamp: Date.now() - 30 * 60 * 1000 },
        { url: 'https://www.yandex.ru', title: '–Ø–Ω–¥–µ–∫—Å', timestamp: Date.now() - 2 * 60 * 60 * 1000 },
        { url: 'https://developer.mozilla.org', title: 'MDN Web Docs', timestamp: Date.now() - 5 * 60 * 60 * 1000 },
        { url: 'https://www.wikipedia.org', title: 'Wikipedia - The Free Encyclopedia', timestamp: Date.now() - 24 * 60 * 60 * 1000 }
      ];
      
      console.log('[–ò—Å—Ç–æ—Ä–∏—è] –ü–æ–∫–∞–∑ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö');
      renderHistory(mockData);
    }
    
    // –ü–æ–∏—Å–∫ –≤ –∏—Å—Ç–æ—Ä–∏–∏
    function searchHistory() {
      const query = searchInput.value.trim();
      if (!query) {
        isSearchMode = false;
        return loadHistory();
      }
      
      console.log(`[–ò—Å—Ç–æ—Ä–∏—è] –ü–æ–∏—Å–∫: "${query}"`);
      historyContainer.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      
      try {
        if (!window.electronAPI || typeof window.electronAPI.searchHistory !== 'function') {
          // –õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫, –µ—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ
          console.log('[–ò—Å—Ç–æ—Ä–∏—è] API –ø–æ–∏—Å–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫');
          const results = historyData.filter(item => 
            item.title.toLowerCase().includes(query.toLowerCase()) || 
            item.url.toLowerCase().includes(query.toLowerCase())
          );
          console.log(`[–ò—Å—Ç–æ—Ä–∏—è] –ù–∞–π–¥–µ–Ω–æ ${results.length} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤`);
          isSearchMode = true;
          renderHistory(results, true);
          return;
        }
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º API –ø–æ–∏—Å–∫–∞
        window.electronAPI.searchHistory(query).then(results => {
          console.log(`[–ò—Å—Ç–æ—Ä–∏—è] –ù–∞–π–¥–µ–Ω–æ ${results.length} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤`);
          isSearchMode = true;
          renderHistory(results, true);
        }).catch(error => {
          console.error('[–ò—Å—Ç–æ—Ä–∏—è] –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
          showError('–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–∏—Å–∫');
        });
      } catch (error) {
        console.error('[–ò—Å—Ç–æ—Ä–∏—è] –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ');
      }
    }
    
    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
    function renderHistory(history, isSearchResults = false) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö
      if (!history || history.length === 0) {
        historyContainer.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üïí</div>
            <h3 class="empty-title">${isSearchResults ? '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ' : '–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—É—Å—Ç–∞'}</h3>
            <p class="empty-message">
              ${isSearchResults 
                ? '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å' 
                : '–ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∏—Å—Ç–æ—Ä–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö —Å–∞–π—Ç–æ–≤'}
            </p>
          </div>
        `;
        return;
      }
      
      // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ –¥–Ω—è–º
      const groupedHistory = groupHistoryByDate(history);
      
      // –°—Ç—Ä–æ–∏–º HTML
      let html = '';
      for (const [date, items] of Object.entries(groupedHistory)) {
        html += `
          <div class="history-group">
            <h3 class="group-header">${date}</h3>
        `;
        
        for (const item of items) {
          const favicon = getFavicon(item.url);
          html += `
            <div class="history-item" data-url="${escapeHtml(item.url)}">
              <img src="${escapeHtml(favicon)}" class="favicon" onerror="this.src='favicon.ico'">
              <div class="history-content">
                <div class="history-title">${escapeHtml(item.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</div>
                <div class="history-url">${escapeHtml(item.url)}</div>
              </div>
              <div class="history-time">${formatTime(item.timestamp)}</div>
              <button class="history-delete" title="–£–¥–∞–ª–∏—Ç—å –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏">‚úï</button>
            </div>
          `;
        }
        
        html += `</div>`;
      }
      
      historyContainer.innerHTML = html;
      
      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
      attachEventHandlers();
    }
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π –∫ —ç–ª–µ–º–µ–Ω—Ç–∞–º –∏—Å—Ç–æ—Ä–∏–∏
    function attachEventHandlers() {
      // –î–ª—è –∑–∞–ø–∏—Å–µ–π –∏—Å—Ç–æ—Ä–∏–∏
      const historyItems = document.querySelectorAll('.history-item');
      historyItems.forEach(item => {
        item.addEventListener('click', (e) => {
          // –ï—Å–ª–∏ –∫–ª–∏–∫ –Ω–µ –Ω–∞ –∫–Ω–æ–ø–∫–µ —É–¥–∞–ª–µ–Ω–∏—è
          if (!e.target.classList.contains('history-delete')) {
            const url = item.dataset.url;
            console.log(`[–ò—Å—Ç–æ—Ä–∏—è] –ü–µ—Ä–µ—Ö–æ–¥: ${url}`);
            
            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –ø–æ URL
            if (window.electronAPI && window.electronAPI.navigate) {
              window.electronAPI.navigate(url);
            } else {
              // –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
              window.location.href = url;
            }
          }
        });
      });
      
      // –î–ª—è –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è
      const deleteButtons = document.querySelectorAll('.history-delete');
      deleteButtons.forEach(button => {
        button.addEventListener('click', (e) => {
          e.stopPropagation();
          const item = button.closest('.history-item');
          const url = item.dataset.url;
          deleteHistoryItem(url, item);
        });
      });
    }
    
    // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ –¥–∞—Ç–∞–º
    function groupHistoryByDate(history) {
      const groups = {};
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
      const yesterday = today - 24 * 60 * 60 * 1000;
      
      history.forEach(item => {
        if (!item || !item.timestamp) return;
        
        const date = new Date(item.timestamp);
        const dateTime = new Date(date.getFullYear(), date.getMonth(), date.getDate()).getTime();
        
        let groupName;
        if (dateTime === today) {
          groupName = '–°–µ–≥–æ–¥–Ω—è';
        } else if (dateTime === yesterday) {
          groupName = '–í—á–µ—Ä–∞';
        } else {
          groupName = date.toLocaleDateString('ru-RU', {
            day: 'numeric',
            month: 'long',
            year: 'numeric'
          });
        }
        
        if (!groups[groupName]) {
          groups[groupName] = [];
        }
        
        groups[groupName].push(item);
      });
      
      return groups;
    }
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
    function formatTime(timestamp) {
      if (!timestamp) return '';
      
      try {
        const date = new Date(timestamp);
        return date.toLocaleTimeString('ru-RU', {
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (e) {
        return '';
      }
    }
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ —Å–∞–π—Ç–∞
    function getFavicon(url) {
      try {
        if (!url) return 'favicon.ico';
        const domain = new URL(url).hostname;
        return `https://www.google.com/s2/favicons?domain=${domain}&sz=64`;
      } catch {
        return 'favicon.ico';
      }
    }
    
    // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
    function deleteHistoryItem(url, element) {
      if (!url || !element) return;
      
      console.log(`[–ò—Å—Ç–æ—Ä–∏—è] –£–¥–∞–ª–µ–Ω–∏–µ: ${url}`);
      
      // –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å API, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ
      if (window.electronAPI && typeof window.electronAPI.deleteHistoryItem === 'function') {
        window.electronAPI.deleteHistoryItem(url)
          .then(result => {
            if (result) animateAndRemove(element);
          })
          .catch(error => {
            console.warn('[–ò—Å—Ç–æ—Ä–∏—è] –û—à–∏–±–∫–∞ API –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:', error);
            // –£–¥–∞–ª—è–µ–º –∏–∑ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ API –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ
            historyData = historyData.filter(item => item.url !== url);
            animateAndRemove(element);
          });
      } else {
        // –ï—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ, –ø—Ä–æ—Å—Ç–æ —É–¥–∞–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ
        console.log('[–ò—Å—Ç–æ—Ä–∏—è] API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ, —É–¥–∞–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ');
        historyData = historyData.filter(item => item.url !== url);
        animateAndRemove(element);
      }
    }
    
    // –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞
    function animateAndRemove(element) {
      element.style.height = element.offsetHeight + 'px';
      element.style.overflow = 'hidden';
      
      setTimeout(() => {
        element.style.transition = 'all 0.3s ease';
        element.style.height = '0';
        element.style.opacity = '0';
        element.style.padding = '0';
        element.style.margin = '0';
        
        setTimeout(() => {
          // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑ DOM
          element.remove();
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—É—Å—Ç–∞ –ª–∏ –≥—Ä—É–ø–ø–∞
          const group = element.closest('.history-group');
          if (group && group.querySelectorAll('.history-item').length === 0) {
            group.remove();
          }
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—É—Å—Ç–∞ –ª–∏ –∏—Å—Ç–æ—Ä–∏—è
          if (historyContainer.querySelectorAll('.history-item').length === 0) {
            showEmptyState();
          }
        }, 300);
      }, 10);
    }
    
    // –ü–æ–∫–∞–∑ –ø—É—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    function showEmptyState() {
      historyContainer.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">üïí</div>
          <h3 class="empty-title">–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—É—Å—Ç–∞</h3>
          <p class="empty-message">–ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∏—Å—Ç–æ—Ä–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö —Å–∞–π—Ç–æ–≤</p>
        </div>
      `;
    }
    
    // –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    function showConfirmModal(period = 'day') {
      selectedPeriod = period;
      
      // –í—ã–±–∏—Ä–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –æ–ø—Ü–∏—é
      const option = document.getElementById(`period${capitalize(period)}`);
      if (option) {
        option.checked = true;
      }
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥
      confirmModal.classList.add('visible');
    }
    
    // –°–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    function hideConfirmModal() {
      confirmModal.classList.remove('visible');
    }
    
    // –û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
    function clearHistory() {
      console.log(`[–ò—Å—Ç–æ—Ä–∏—è] –û—á–∏—Å—Ç–∫–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥: ${selectedPeriod}`);
      
      try {
        // –ï—Å–ª–∏ API –¥–æ—Å—Ç—É–ø–Ω–æ
        if (window.electronAPI && 
            ((selectedPeriod === 'all' && typeof window.electronAPI.clearHistory === 'function') || 
             (selectedPeriod !== 'all' && typeof window.electronAPI.clearHistoryPeriod === 'function'))) {
          
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º API –¥–ª—è –æ—á–∏—Å—Ç–∫–∏
          let promise;
          if (selectedPeriod === 'all') {
            promise = window.electronAPI.clearHistory();
          } else {
            promise = window.electronAPI.clearHistoryPeriod(selectedPeriod);
          }
          
          promise.then(result => {
            hideConfirmModal();
            loadHistory();
          }).catch(error => {
            console.error('[–ò—Å—Ç–æ—Ä–∏—è] –û—à–∏–±–∫–∞ API –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ:', error);
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é');
          });
        } else {
          // –ï—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ, –æ—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
          console.log('[–ò—Å—Ç–æ—Ä–∏—è] API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ, –æ—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ');
          historyData = [];
          hideConfirmModal();
          showEmptyState();
        }
      } catch (error) {
        console.error('[–ò—Å—Ç–æ—Ä–∏—è] –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ:', error);
        hideConfirmModal();
        showEmptyState();
      }
    }
    
    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—à–∏–±–∫–∏
    function showError(message) {
      console.error(`[–ò—Å—Ç–æ—Ä–∏—è] ${message}`);
      historyContainer.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">‚ö†Ô∏è</div>
          <h3 class="empty-title">–û—à–∏–±–∫–∞</h3>
          <p class="empty-message">${message}</p>
        </div>
      `;
    }
    
    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function capitalize(string) {
      return string.charAt(0).toUpperCase() + string.slice(1);
    }
    
    function escapeHtml(unsafe) {
      return (unsafe || '')
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html> 